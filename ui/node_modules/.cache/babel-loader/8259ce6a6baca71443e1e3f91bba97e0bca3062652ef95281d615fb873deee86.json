{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{useParams,useNavigate}from'react-router-dom';import{getTripsFromLocalStorage}from'../utils/tripUtils';import'./TripChat.css';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const TripChat=()=>{const{tripId}=useParams();const navigate=useNavigate();const[messages,setMessages]=useState([]);const[inputMessage,setInputMessage]=useState('');const[isLoading,setIsLoading]=useState(false);const[tripInfo,setTripInfo]=useState(null);const[sharedUsers,setSharedUsers]=useState([]);const[showInviteModal,setShowInviteModal]=useState(false);const[inviteEmail,setInviteEmail]=useState('');const messagesEndRef=useRef(null);const inputRef=useRef(null);const API_ENDPOINT=process.env.REACT_APP_API_URL||'http://localhost:8000/api/trip-planner';// Fetch trip info and generate initial plan\nuseEffect(()=>{let isMounted=true;const fetchTripDataAndGeneratePlan=async()=>{try{// First, try to get trip from localStorage\nconst localTrips=getTripsFromLocalStorage();const localTrip=localTrips.find(trip=>trip.id===tripId);if(localTrip&&isMounted){setTripInfo({id:localTrip.id,title:localTrip.title,destination:localTrip.destination,image:localTrip.image,prompt:localTrip.prompt});}// Try to fetch from backend API\ntry{const tripResponse=await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"?userId=Kartik7\"));if(tripResponse.ok&&isMounted){const tripData=await tripResponse.json();setTripInfo(prev=>prev||tripData);}}catch(err){console.log('Could not fetch from backend, using local data');}// Fetch existing messages\nlet hasExistingMessages=false;try{const messagesResponse=await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"/messages?userId=Kartik7\"));if(messagesResponse.ok){const messagesData=await messagesResponse.json();if(messagesData.messages&&messagesData.messages.length>0&&isMounted){setMessages(messagesData.messages);hasExistingMessages=true;}}}catch(err){console.log('Could not fetch messages from backend');// Try to load from localStorage as backup\ntry{const key=\"trip_chat_\".concat(tripId);const localMessages=JSON.parse(localStorage.getItem(key)||'[]');if(localMessages.length>0&&isMounted){setMessages(localMessages);hasExistingMessages=true;}}catch(localErr){console.log('Could not load messages from localStorage');}}// If no messages exist and we have a prompt, generate the initial plan\nif(!hasExistingMessages){const tripPrompt=localTrip===null||localTrip===void 0?void 0:localTrip.prompt;if(tripPrompt&&isMounted){await generateInitialTravelPlan(tripPrompt);}}}catch(error){console.error('Error fetching trip data:',error);if(!isMounted)return;// Use fallback data\nconst localTrips=getTripsFromLocalStorage();const localTrip=localTrips.find(trip=>trip.id===tripId);if(localTrip&&isMounted){setTripInfo({id:localTrip.id,title:localTrip.title,destination:localTrip.destination,image:localTrip.image,prompt:localTrip.prompt});// Generate plan with local trip prompt\nif(localTrip.prompt){await generateInitialTravelPlan(localTrip.prompt);}}else if(isMounted){setTripInfo({id:tripId,title:\"Trip \".concat(tripId),destination:'Unknown',image:'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&h=400&fit=crop'});}}};fetchTripDataAndGeneratePlan();return()=>{isMounted=false;};},[tripId]);// Generate initial comprehensive travel plan using ChatGPT\nconst generateInitialTravelPlan=async prompt=>{setIsLoading(true);const systemPrompt=\"You are an expert travel planning AI assistant. Your role is to create comprehensive, personalized travel itineraries based on user requests.\\n\\nIMPORTANT INSTRUCTIONS:\\n1. Analyze the user's travel request carefully and extract all available information\\n2. Use your knowledge to fill in reasonable defaults for missing information (e.g., if no dates mentioned, suggest optimal travel times; if no budget mentioned, provide options for different budget ranges)\\n3. Create a COMPLETE, DETAILED, PERSONALIZED itinerary immediately - do NOT ask questions first\\n4. Include ALL of the following in your response:\\n   - Pre-trip preparation (medical requirements, vaccinations, shopping list)\\n   - Day-by-day itinerary with:\\n     * Travel/Transportation details\\n     * Hotel/Accommodation recommendations with specific names and locations\\n     * Restaurant recommendations for breakfast, lunch, and dinner each day\\n     * Activities and sightseeing\\n     * Shopping recommendations\\n     * Weather forecast and packing suggestions\\n   - Post-trip recommendations\\n5. Make it specific and actionable - use real place names, realistic times, and practical details\\n6. Format with clear sections, bullet points, and organized structure\\n7. After providing the complete plan, you can mention: \\\"Feel free to ask me to modify any part of this itinerary or add more details!\\\"\";const userPrompt=\"Please create a comprehensive, personalized travel plan based on this request: \\\"\".concat(prompt,\"\\\"\\n\\nProvide a complete itinerary with all details including travel, hotels, restaurants, activities, shopping, medical requirements, and weather information. Use your knowledge to fill in any missing details with reasonable assumptions.\");try{// Save user's initial prompt as first message\nconst initialUserMessage={id:Date.now(),role:'user',content:prompt,timestamp:new Date().toISOString()};// Save to backend\nawait saveMessageToBackend(initialUserMessage);// Call ChatGPT API with timeout\nconst controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),30000);// 30 second timeout\ntry{const response=await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"/chat\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:'Kartik7',tripId:tripId,message:userPrompt,systemPrompt:systemPrompt,conversationHistory:[],timestamp:new Date().toISOString(),isInitialPlan:true}),signal:controller.signal});clearTimeout(timeoutId);if(response.ok){const data=await response.json();const aiMessage={id:Date.now()+1,role:'assistant',content:data.response||data.message||data.plan||'I\\'m creating your personalized travel plan...',timestamp:new Date().toISOString()};// Save AI response to backend\nawait saveMessageToBackend(aiMessage);setMessages([initialUserMessage,aiMessage]);}else{throw new Error(\"API returned status \".concat(response.status));}}catch(fetchError){clearTimeout(timeoutId);if(fetchError.name==='AbortError'){throw new Error('Request timed out. Please try again.');}throw fetchError;}}catch(error){console.error('Error generating travel plan:',error);// Show error message to user instead of sample plan\nconst initialUserMessage={id:Date.now(),role:'user',content:prompt,timestamp:new Date().toISOString()};const errorMessage={id:Date.now()+1,role:'assistant',content:\"I apologize, but I'm having trouble connecting to the AI service right now. Please try sending your message again, or refresh the page. If the problem persists, the service may be temporarily unavailable.\\n\\nError: \".concat(error.message),timestamp:new Date().toISOString()};await saveMessageToBackend(initialUserMessage).catch(()=>{});await saveMessageToBackend(errorMessage).catch(()=>{});setMessages([initialUserMessage,errorMessage]);}finally{setIsLoading(false);}};// Save message to backend\nconst saveMessageToBackend=async message=>{try{await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"/messages\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:'Kartik7',tripId:tripId,message:message,timestamp:message.timestamp})});}catch(error){console.error('Error saving message to backend:',error);// Also save to localStorage as backup\nsaveMessageToLocalStorage(message);}};// Save message to localStorage as backup\nconst saveMessageToLocalStorage=message=>{try{const key=\"trip_chat_\".concat(tripId);const existingMessages=JSON.parse(localStorage.getItem(key)||'[]');existingMessages.push(message);localStorage.setItem(key,JSON.stringify(existingMessages));}catch(error){console.error('Error saving message to localStorage:',error);}};// Create a sample plan structure if API fails\nconst createSamplePlan=prompt=>{return\"# Your Personalized Travel Plan\\n\\nBased on your request: \\\"\".concat(prompt,\"\\\"\\n\\n## Pre-Trip Preparation\\n\\n### Medical Requirements\\n\\u2022 Consult with your doctor 4-6 weeks before travel\\n\\u2022 Check required vaccinations for your destination\\n\\u2022 Pack prescription medications in original containers\\n\\u2022 Bring copies of prescriptions and medical records\\n\\u2022 Consider travel insurance with medical coverage\\n\\n### Shopping Before Trip\\n\\u2022 Travel adapter and converter\\n\\u2022 Portable charger/power bank\\n\\u2022 Travel-sized toiletries\\n\\u2022 Comfortable walking shoes\\n\\u2022 Weather-appropriate clothing\\n\\u2022 Travel documents organizer\\n\\n---\\n\\n## Day-by-Day Itinerary\\n\\n### Day 1: Arrival\\n**Travel:**\\n\\u2022 Flight arrival at [Destination Airport]\\n\\u2022 Airport transfer to hotel\\n\\n**Hotel:**\\n\\u2022 Check-in at [Recommended Hotel]\\n\\u2022 Location: [Area/District]\\n\\n**Restaurants:**\\n\\u2022 Breakfast: [Local Caf\\xE9]\\n\\u2022 Lunch: [Traditional Restaurant]\\n\\u2022 Dinner: [Fine Dining Option]\\n\\n**Weather Forecast:**\\n\\u2022 Temperature: [Range]\\xB0C\\n\\u2022 Conditions: [Sunny/Cloudy/Rainy]\\n\\u2022 Pack: [Appropriate clothing]\\n\\n**Shopping:**\\n\\u2022 Visit [Local Market] for essentials\\n\\u2022 Purchase [Local SIM card/Transportation pass]\\n\\n---\\n\\n### Day 2: Exploration\\n**Travel:**\\n\\u2022 Public transportation pass\\n\\u2022 Walking tours\\n\\n**Hotel:**\\n\\u2022 Continue stay at [Hotel Name]\\n\\n**Restaurants:**\\n\\u2022 Breakfast: [Hotel breakfast]\\n\\u2022 Lunch: [Street food/Market]\\n\\u2022 Dinner: [Rooftop restaurant]\\n\\n**Weather Forecast:**\\n\\u2022 Temperature: [Range]\\xB0C\\n\\u2022 Conditions: [Weather conditions]\\n\\n**Shopping:**\\n\\u2022 [Local souvenirs]\\n\\u2022 [Traditional items]\\n\\n---\\n\\n*[Additional days will be generated based on your trip duration]*\\n\\n---\\n\\n## Post-Trip Recommendations\\n\\n### Shopping After Trip\\n\\u2022 [Local specialties to bring home]\\n\\u2022 [Duty-free items]\\n\\u2022 [Gifts for family/friends]\\n\\n### Follow-up\\n\\u2022 Review travel insurance claims if needed\\n\\u2022 Share feedback on accommodations\\n\\u2022 Plan your next adventure!\\n\\n*This is a sample structure. Your actual plan will be customized based on your specific requirements and destination.*\");};// Auto-scroll to bottom when messages change\nuseEffect(()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:'smooth'});},[messages]);// Auto-focus input on mount\nuseEffect(()=>{var _inputRef$current;(_inputRef$current=inputRef.current)===null||_inputRef$current===void 0?void 0:_inputRef$current.focus();},[]);const handleSendMessage=async e=>{e.preventDefault();if(!inputMessage.trim()||isLoading)return;const userMessage={id:Date.now(),role:'user',content:inputMessage.trim(),timestamp:new Date().toISOString()};// Add user message immediately\nconst updatedMessages=[...messages,userMessage];setMessages(updatedMessages);setInputMessage('');setIsLoading(true);// Save user message to backend\nawait saveMessageToBackend(userMessage);try{// Prepare conversation history for ChatGPT\nconst conversationHistory=updatedMessages.map(msg=>({role:msg.role,content:msg.content}));const systemPrompt=\"You are an expert travel planning AI assistant. Help users create comprehensive, personalized travel itineraries. Ask questions when you need more information. Provide detailed day-by-day plans with travel, hotels, restaurants, shopping, medical requirements, and weather forecasts.\";// Send message to ChatGPT API with timeout\nconst controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),30000);// 30 second timeout\ntry{const response=await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"/chat\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:'Kartik7',tripId:tripId,message:userMessage.content,systemPrompt:systemPrompt,conversationHistory:conversationHistory,timestamp:userMessage.timestamp}),signal:controller.signal});clearTimeout(timeoutId);if(response.ok){const data=await response.json();// Add AI response\nconst aiMessage={id:Date.now()+1,role:'assistant',content:data.response||data.message||'I received your message. How can I help you with your trip?',timestamp:new Date().toISOString()};// Save AI response to backend\nawait saveMessageToBackend(aiMessage);setMessages(prev=>[...prev,aiMessage]);}else{throw new Error(\"API returned status \".concat(response.status));}}catch(fetchError){clearTimeout(timeoutId);if(fetchError.name==='AbortError'){const timeoutMessage={id:Date.now()+1,role:'assistant',content:'The request is taking longer than expected. Please try again, or check your connection.',timestamp:new Date().toISOString()};await saveMessageToBackend(timeoutMessage);setMessages(prev=>[...prev,timeoutMessage]);}else{throw fetchError;}}}catch(error){console.error('Error sending message:',error);// Error response\nconst errorMessage={id:Date.now()+1,role:'assistant',content:\"I apologize, but I encountered an error processing your request. Please try again. If the problem persists, the service may be temporarily unavailable.\\n\\nError: \".concat(error.message),timestamp:new Date().toISOString()};await saveMessageToBackend(errorMessage);setMessages(prev=>[...prev,errorMessage]);}finally{setIsLoading(false);}};// Invite user to view chat\nconst handleInviteUser=async e=>{e.preventDefault();if(!inviteEmail.trim())return;try{const response=await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"/invite\"),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:'Kartik7',tripId:tripId,inviteEmail:inviteEmail.trim()})});if(response.ok){const data=await response.json();setSharedUsers(prev=>[...prev,{email:inviteEmail.trim(),status:'invited'}]);setInviteEmail('');setShowInviteModal(false);alert(\"Invitation sent to \".concat(inviteEmail.trim()));}else{alert('Failed to send invitation. Please try again.');}}catch(error){console.error('Error inviting user:',error);alert('Failed to send invitation. Please try again.');}};// Fetch shared users\nuseEffect(()=>{const fetchSharedUsers=async()=>{try{const response=await fetch(\"\".concat(API_ENDPOINT,\"/trips/\").concat(tripId,\"/shared-users?userId=Kartik7\"));if(response.ok){const data=await response.json();setSharedUsers(data.sharedUsers||[]);}}catch(error){console.error('Error fetching shared users:',error);}};fetchSharedUsers();},[tripId]);const handleKeyDown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendMessage(e);}};// Format message content for better display (markdown-like formatting)\nconst formatMessageContent=content=>{if(!content)return'';// Convert markdown-style formatting to HTML\nlet formatted=content// Headers\n.replace(/^### (.*$)/gim,'<h3>$1</h3>').replace(/^## (.*$)/gim,'<h2>$1</h2>').replace(/^# (.*$)/gim,'<h1>$1</h1>')// Bold\n.replace(/\\*\\*(.*?)\\*\\*/gim,'<strong>$1</strong>')// Bullet points\n.replace(/^• (.*$)/gim,'<li>$1</li>').replace(/^- (.*$)/gim,'<li>$1</li>')// Line breaks\n.replace(/\\n/g,'<br>');// Wrap consecutive <li> tags in <ul>\nformatted=formatted.replace(/(<li>.*?<\\/li>(?:<br>)?)+/g,match=>{return'<ul>'+match.replace(/<br>/g,'')+'</ul>';});return formatted;};return/*#__PURE__*/_jsxs(\"div\",{className:\"trip-chat-page\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"back-button\",onClick:()=>navigate('/trips'),children:[/*#__PURE__*/_jsx(\"svg\",{width:\"20\",height:\"20\",viewBox:\"0 0 24 24\",fill:\"none\",xmlns:\"http://www.w3.org/2000/svg\",children:/*#__PURE__*/_jsx(\"path\",{d:\"M19 12H5M5 12L12 19M5 12L12 5\",stroke:\"currentColor\",strokeWidth:\"2\",strokeLinecap:\"round\",strokeLinejoin:\"round\"})}),\"Back to My Trips\"]}),tripInfo&&/*#__PURE__*/_jsxs(\"div\",{className:\"trip-chat-header\",children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'20px',flex:1},children:[/*#__PURE__*/_jsx(\"div\",{className:\"trip-chat-header-image\",children:/*#__PURE__*/_jsx(\"img\",{src:tripInfo.image,alt:tripInfo.destination})}),/*#__PURE__*/_jsxs(\"div\",{className:\"trip-chat-header-info\",children:[/*#__PURE__*/_jsx(\"h2\",{children:tripInfo.title||\"Trip \".concat(tripId)}),/*#__PURE__*/_jsx(\"p\",{children:tripInfo.destination||'Unknown Destination'})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"trip-chat-header-actions\",children:[/*#__PURE__*/_jsxs(\"button\",{className:\"invite-button\",onClick:()=>setShowInviteModal(true),title:\"Invite user to view chat\",children:[/*#__PURE__*/_jsxs(\"svg\",{width:\"18\",height:\"18\",viewBox:\"0 0 24 24\",fill:\"none\",xmlns:\"http://www.w3.org/2000/svg\",children:[/*#__PURE__*/_jsx(\"path\",{d:\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\",stroke:\"currentColor\",strokeWidth:\"2\",strokeLinecap:\"round\",strokeLinejoin:\"round\"}),/*#__PURE__*/_jsx(\"circle\",{cx:\"8.5\",cy:\"7\",r:\"4\",stroke:\"currentColor\",strokeWidth:\"2\",strokeLinecap:\"round\",strokeLinejoin:\"round\"}),/*#__PURE__*/_jsx(\"path\",{d:\"M20 8v6M23 11h-6\",stroke:\"currentColor\",strokeWidth:\"2\",strokeLinecap:\"round\",strokeLinejoin:\"round\"})]}),\"Invite\"]}),sharedUsers.length>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"shared-users\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"shared-users-label\",children:\"Shared with:\"}),sharedUsers.map((user,idx)=>/*#__PURE__*/_jsx(\"span\",{className:\"shared-user-badge\",children:user.email},idx))]})]})]}),showInviteModal&&/*#__PURE__*/_jsx(\"div\",{className:\"invite-modal-overlay\",onClick:()=>setShowInviteModal(false),children:/*#__PURE__*/_jsxs(\"div\",{className:\"invite-modal\",onClick:e=>e.stopPropagation(),children:[/*#__PURE__*/_jsx(\"h3\",{children:\"Invite User to View Chat\"}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleInviteUser,children:[/*#__PURE__*/_jsx(\"input\",{type:\"email\",className:\"invite-email-input\",placeholder:\"Enter email address\",value:inviteEmail,onChange:e=>setInviteEmail(e.target.value),required:true}),/*#__PURE__*/_jsxs(\"div\",{className:\"invite-modal-actions\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>setShowInviteModal(false),children:\"Cancel\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",children:\"Send Invitation\"})]})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"chat-container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chat-messages\",ref:messagesEndRef,children:[messages.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"chat-empty-state\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"empty-state-icon\",children:/*#__PURE__*/_jsx(\"svg\",{width:\"64\",height:\"64\",viewBox:\"0 0 24 24\",fill:\"none\",xmlns:\"http://www.w3.org/2000/svg\",children:/*#__PURE__*/_jsx(\"path\",{d:\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\",stroke:\"currentColor\",strokeWidth:\"2\",strokeLinecap:\"round\",strokeLinejoin:\"round\"})})}),/*#__PURE__*/_jsx(\"h3\",{children:\"Start a conversation\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Ask questions about your trip, request changes, or get recommendations.\"})]}):messages.map(message=>/*#__PURE__*/_jsxs(\"div\",{className:\"message \".concat(message.role==='user'?'user-message':'assistant-message'),children:[/*#__PURE__*/_jsx(\"div\",{className:\"message-content\",dangerouslySetInnerHTML:{__html:message.role==='assistant'?formatMessageContent(message.content):message.content}}),/*#__PURE__*/_jsx(\"div\",{className:\"message-timestamp\",children:new Date(message.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})})]},message.id)),isLoading&&/*#__PURE__*/_jsx(\"div\",{className:\"message assistant-message\",children:/*#__PURE__*/_jsx(\"div\",{className:\"message-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"loading-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"loading-spinner\"}),/*#__PURE__*/_jsx(\"p\",{className:\"loading-text\",children:\"Creating your personalized travel plan...\"}),/*#__PURE__*/_jsx(\"p\",{className:\"loading-subtext\",children:\"This may take a few moments\"})]})})}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsx(\"form\",{className:\"chat-input-form\",onSubmit:handleSendMessage,children:/*#__PURE__*/_jsxs(\"div\",{className:\"chat-input-wrapper\",children:[/*#__PURE__*/_jsx(\"textarea\",{ref:inputRef,className:\"chat-input\",value:inputMessage,onChange:e=>setInputMessage(e.target.value),onKeyDown:handleKeyDown,placeholder:\"Message your trip assistant...\",rows:\"1\",disabled:isLoading}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"chat-send-button\",disabled:!inputMessage.trim()||isLoading,children:/*#__PURE__*/_jsx(\"svg\",{width:\"20\",height:\"20\",viewBox:\"0 0 24 24\",fill:\"none\",xmlns:\"http://www.w3.org/2000/svg\",children:/*#__PURE__*/_jsx(\"path\",{d:\"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13\",stroke:\"currentColor\",strokeWidth:\"2\",strokeLinecap:\"round\",strokeLinejoin:\"round\"})})})]})})]})]});};export default TripChat;","map":{"version":3,"names":["React","useState","useEffect","useRef","useParams","useNavigate","getTripsFromLocalStorage","jsx","_jsx","jsxs","_jsxs","TripChat","tripId","navigate","messages","setMessages","inputMessage","setInputMessage","isLoading","setIsLoading","tripInfo","setTripInfo","sharedUsers","setSharedUsers","showInviteModal","setShowInviteModal","inviteEmail","setInviteEmail","messagesEndRef","inputRef","API_ENDPOINT","process","env","REACT_APP_API_URL","isMounted","fetchTripDataAndGeneratePlan","localTrips","localTrip","find","trip","id","title","destination","image","prompt","tripResponse","fetch","concat","ok","tripData","json","prev","err","console","log","hasExistingMessages","messagesResponse","messagesData","length","key","localMessages","JSON","parse","localStorage","getItem","localErr","tripPrompt","generateInitialTravelPlan","error","systemPrompt","userPrompt","initialUserMessage","Date","now","role","content","timestamp","toISOString","saveMessageToBackend","controller","AbortController","timeoutId","setTimeout","abort","response","method","headers","body","stringify","userId","message","conversationHistory","isInitialPlan","signal","clearTimeout","data","aiMessage","plan","Error","status","fetchError","name","errorMessage","catch","saveMessageToLocalStorage","existingMessages","push","setItem","createSamplePlan","_messagesEndRef$curre","current","scrollIntoView","behavior","_inputRef$current","focus","handleSendMessage","e","preventDefault","trim","userMessage","updatedMessages","map","msg","timeoutMessage","handleInviteUser","email","alert","fetchSharedUsers","handleKeyDown","shiftKey","formatMessageContent","formatted","replace","match","className","children","onClick","width","height","viewBox","fill","xmlns","d","stroke","strokeWidth","strokeLinecap","strokeLinejoin","style","display","alignItems","gap","flex","src","alt","cx","cy","r","user","idx","stopPropagation","onSubmit","type","placeholder","value","onChange","target","required","ref","dangerouslySetInnerHTML","__html","toLocaleTimeString","hour","minute","onKeyDown","rows","disabled"],"sources":["C:/Users/Admin/OneDrive/Desktop/Princeton/src/pages/TripChat.js"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { getTripsFromLocalStorage } from '../utils/tripUtils';\r\nimport './TripChat.css';\r\n\r\nconst TripChat = () => {\r\n  const { tripId } = useParams();\r\n  const navigate = useNavigate();\r\n  const [messages, setMessages] = useState([]);\r\n  const [inputMessage, setInputMessage] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [tripInfo, setTripInfo] = useState(null);\r\n  const [sharedUsers, setSharedUsers] = useState([]);\r\n  const [showInviteModal, setShowInviteModal] = useState(false);\r\n  const [inviteEmail, setInviteEmail] = useState('');\r\n  const messagesEndRef = useRef(null);\r\n  const inputRef = useRef(null);\r\n\r\n  const API_ENDPOINT = process.env.REACT_APP_API_URL || 'http://localhost:8000/api/trip-planner';\r\n\r\n  // Fetch trip info and generate initial plan\r\n  useEffect(() => {\r\n    let isMounted = true;\r\n    \r\n    const fetchTripDataAndGeneratePlan = async () => {\r\n      try {\r\n        // First, try to get trip from localStorage\r\n        const localTrips = getTripsFromLocalStorage();\r\n        const localTrip = localTrips.find(trip => trip.id === tripId);\r\n        \r\n        if (localTrip && isMounted) {\r\n          setTripInfo({\r\n            id: localTrip.id,\r\n            title: localTrip.title,\r\n            destination: localTrip.destination,\r\n            image: localTrip.image,\r\n            prompt: localTrip.prompt\r\n          });\r\n        }\r\n\r\n        // Try to fetch from backend API\r\n        try {\r\n          const tripResponse = await fetch(`${API_ENDPOINT}/trips/${tripId}?userId=Kartik7`);\r\n          if (tripResponse.ok && isMounted) {\r\n            const tripData = await tripResponse.json();\r\n            setTripInfo(prev => prev || tripData);\r\n          }\r\n        } catch (err) {\r\n          console.log('Could not fetch from backend, using local data');\r\n        }\r\n\r\n        // Fetch existing messages\r\n        let hasExistingMessages = false;\r\n        try {\r\n          const messagesResponse = await fetch(`${API_ENDPOINT}/trips/${tripId}/messages?userId=Kartik7`);\r\n          if (messagesResponse.ok) {\r\n            const messagesData = await messagesResponse.json();\r\n            if (messagesData.messages && messagesData.messages.length > 0 && isMounted) {\r\n              setMessages(messagesData.messages);\r\n              hasExistingMessages = true;\r\n            }\r\n          }\r\n        } catch (err) {\r\n          console.log('Could not fetch messages from backend');\r\n          // Try to load from localStorage as backup\r\n          try {\r\n            const key = `trip_chat_${tripId}`;\r\n            const localMessages = JSON.parse(localStorage.getItem(key) || '[]');\r\n            if (localMessages.length > 0 && isMounted) {\r\n              setMessages(localMessages);\r\n              hasExistingMessages = true;\r\n            }\r\n          } catch (localErr) {\r\n            console.log('Could not load messages from localStorage');\r\n          }\r\n        }\r\n\r\n        // If no messages exist and we have a prompt, generate the initial plan\r\n        if (!hasExistingMessages) {\r\n          const tripPrompt = localTrip?.prompt;\r\n          if (tripPrompt && isMounted) {\r\n            await generateInitialTravelPlan(tripPrompt);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('Error fetching trip data:', error);\r\n        if (!isMounted) return;\r\n        \r\n        // Use fallback data\r\n        const localTrips = getTripsFromLocalStorage();\r\n        const localTrip = localTrips.find(trip => trip.id === tripId);\r\n        if (localTrip && isMounted) {\r\n          setTripInfo({\r\n            id: localTrip.id,\r\n            title: localTrip.title,\r\n            destination: localTrip.destination,\r\n            image: localTrip.image,\r\n            prompt: localTrip.prompt\r\n          });\r\n          // Generate plan with local trip prompt\r\n          if (localTrip.prompt) {\r\n            await generateInitialTravelPlan(localTrip.prompt);\r\n          }\r\n        } else if (isMounted) {\r\n          setTripInfo({\r\n            id: tripId,\r\n            title: `Trip ${tripId}`,\r\n            destination: 'Unknown',\r\n            image: 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&h=400&fit=crop'\r\n          });\r\n        }\r\n      }\r\n    };\r\n\r\n    fetchTripDataAndGeneratePlan();\r\n    \r\n    return () => {\r\n      isMounted = false;\r\n    };\r\n  }, [tripId]);\r\n\r\n  // Generate initial comprehensive travel plan using ChatGPT\r\n  const generateInitialTravelPlan = async (prompt) => {\r\n    setIsLoading(true);\r\n    \r\n    const systemPrompt = `You are an expert travel planning AI assistant. Your role is to create comprehensive, personalized travel itineraries based on user requests.\r\n\r\nIMPORTANT INSTRUCTIONS:\r\n1. Analyze the user's travel request carefully and extract all available information\r\n2. Use your knowledge to fill in reasonable defaults for missing information (e.g., if no dates mentioned, suggest optimal travel times; if no budget mentioned, provide options for different budget ranges)\r\n3. Create a COMPLETE, DETAILED, PERSONALIZED itinerary immediately - do NOT ask questions first\r\n4. Include ALL of the following in your response:\r\n   - Pre-trip preparation (medical requirements, vaccinations, shopping list)\r\n   - Day-by-day itinerary with:\r\n     * Travel/Transportation details\r\n     * Hotel/Accommodation recommendations with specific names and locations\r\n     * Restaurant recommendations for breakfast, lunch, and dinner each day\r\n     * Activities and sightseeing\r\n     * Shopping recommendations\r\n     * Weather forecast and packing suggestions\r\n   - Post-trip recommendations\r\n5. Make it specific and actionable - use real place names, realistic times, and practical details\r\n6. Format with clear sections, bullet points, and organized structure\r\n7. After providing the complete plan, you can mention: \"Feel free to ask me to modify any part of this itinerary or add more details!\"`;\r\n\r\n    const userPrompt = `Please create a comprehensive, personalized travel plan based on this request: \"${prompt}\"\r\n\r\nProvide a complete itinerary with all details including travel, hotels, restaurants, activities, shopping, medical requirements, and weather information. Use your knowledge to fill in any missing details with reasonable assumptions.`;\r\n\r\n    try {\r\n      // Save user's initial prompt as first message\r\n      const initialUserMessage = {\r\n        id: Date.now(),\r\n        role: 'user',\r\n        content: prompt,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n      \r\n      // Save to backend\r\n      await saveMessageToBackend(initialUserMessage);\r\n\r\n      // Call ChatGPT API with timeout\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\r\n\r\n      try {\r\n        const response = await fetch(`${API_ENDPOINT}/trips/${tripId}/chat`, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            userId: 'Kartik7',\r\n            tripId: tripId,\r\n            message: userPrompt,\r\n            systemPrompt: systemPrompt,\r\n            conversationHistory: [],\r\n            timestamp: new Date().toISOString(),\r\n            isInitialPlan: true\r\n          }),\r\n          signal: controller.signal\r\n        });\r\n\r\n        clearTimeout(timeoutId);\r\n\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          const aiMessage = {\r\n            id: Date.now() + 1,\r\n            role: 'assistant',\r\n            content: data.response || data.message || data.plan || 'I\\'m creating your personalized travel plan...',\r\n            timestamp: new Date().toISOString()\r\n          };\r\n          \r\n          // Save AI response to backend\r\n          await saveMessageToBackend(aiMessage);\r\n          \r\n          setMessages([initialUserMessage, aiMessage]);\r\n        } else {\r\n          throw new Error(`API returned status ${response.status}`);\r\n        }\r\n      } catch (fetchError) {\r\n        clearTimeout(timeoutId);\r\n        if (fetchError.name === 'AbortError') {\r\n          throw new Error('Request timed out. Please try again.');\r\n        }\r\n        throw fetchError;\r\n      }\r\n    } catch (error) {\r\n      console.error('Error generating travel plan:', error);\r\n      // Show error message to user instead of sample plan\r\n      const initialUserMessage = {\r\n        id: Date.now(),\r\n        role: 'user',\r\n        content: prompt,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n      const errorMessage = {\r\n        id: Date.now() + 1,\r\n        role: 'assistant',\r\n        content: `I apologize, but I'm having trouble connecting to the AI service right now. Please try sending your message again, or refresh the page. If the problem persists, the service may be temporarily unavailable.\\n\\nError: ${error.message}`,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n      await saveMessageToBackend(initialUserMessage).catch(() => {});\r\n      await saveMessageToBackend(errorMessage).catch(() => {});\r\n      setMessages([initialUserMessage, errorMessage]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Save message to backend\r\n  const saveMessageToBackend = async (message) => {\r\n    try {\r\n      await fetch(`${API_ENDPOINT}/trips/${tripId}/messages`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          userId: 'Kartik7',\r\n          tripId: tripId,\r\n          message: message,\r\n          timestamp: message.timestamp\r\n        })\r\n      });\r\n    } catch (error) {\r\n      console.error('Error saving message to backend:', error);\r\n      // Also save to localStorage as backup\r\n      saveMessageToLocalStorage(message);\r\n    }\r\n  };\r\n\r\n  // Save message to localStorage as backup\r\n  const saveMessageToLocalStorage = (message) => {\r\n    try {\r\n      const key = `trip_chat_${tripId}`;\r\n      const existingMessages = JSON.parse(localStorage.getItem(key) || '[]');\r\n      existingMessages.push(message);\r\n      localStorage.setItem(key, JSON.stringify(existingMessages));\r\n    } catch (error) {\r\n      console.error('Error saving message to localStorage:', error);\r\n    }\r\n  };\r\n\r\n  // Create a sample plan structure if API fails\r\n  const createSamplePlan = (prompt) => {\r\n    return `# Your Personalized Travel Plan\r\n\r\nBased on your request: \"${prompt}\"\r\n\r\n## Pre-Trip Preparation\r\n\r\n### Medical Requirements\r\n• Consult with your doctor 4-6 weeks before travel\r\n• Check required vaccinations for your destination\r\n• Pack prescription medications in original containers\r\n• Bring copies of prescriptions and medical records\r\n• Consider travel insurance with medical coverage\r\n\r\n### Shopping Before Trip\r\n• Travel adapter and converter\r\n• Portable charger/power bank\r\n• Travel-sized toiletries\r\n• Comfortable walking shoes\r\n• Weather-appropriate clothing\r\n• Travel documents organizer\r\n\r\n---\r\n\r\n## Day-by-Day Itinerary\r\n\r\n### Day 1: Arrival\r\n**Travel:**\r\n• Flight arrival at [Destination Airport]\r\n• Airport transfer to hotel\r\n\r\n**Hotel:**\r\n• Check-in at [Recommended Hotel]\r\n• Location: [Area/District]\r\n\r\n**Restaurants:**\r\n• Breakfast: [Local Café]\r\n• Lunch: [Traditional Restaurant]\r\n• Dinner: [Fine Dining Option]\r\n\r\n**Weather Forecast:**\r\n• Temperature: [Range]°C\r\n• Conditions: [Sunny/Cloudy/Rainy]\r\n• Pack: [Appropriate clothing]\r\n\r\n**Shopping:**\r\n• Visit [Local Market] for essentials\r\n• Purchase [Local SIM card/Transportation pass]\r\n\r\n---\r\n\r\n### Day 2: Exploration\r\n**Travel:**\r\n• Public transportation pass\r\n• Walking tours\r\n\r\n**Hotel:**\r\n• Continue stay at [Hotel Name]\r\n\r\n**Restaurants:**\r\n• Breakfast: [Hotel breakfast]\r\n• Lunch: [Street food/Market]\r\n• Dinner: [Rooftop restaurant]\r\n\r\n**Weather Forecast:**\r\n• Temperature: [Range]°C\r\n• Conditions: [Weather conditions]\r\n\r\n**Shopping:**\r\n• [Local souvenirs]\r\n• [Traditional items]\r\n\r\n---\r\n\r\n*[Additional days will be generated based on your trip duration]*\r\n\r\n---\r\n\r\n## Post-Trip Recommendations\r\n\r\n### Shopping After Trip\r\n• [Local specialties to bring home]\r\n• [Duty-free items]\r\n• [Gifts for family/friends]\r\n\r\n### Follow-up\r\n• Review travel insurance claims if needed\r\n• Share feedback on accommodations\r\n• Plan your next adventure!\r\n\r\n*This is a sample structure. Your actual plan will be customized based on your specific requirements and destination.*`;\r\n  };\r\n\r\n  // Auto-scroll to bottom when messages change\r\n  useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, [messages]);\r\n\r\n  // Auto-focus input on mount\r\n  useEffect(() => {\r\n    inputRef.current?.focus();\r\n  }, []);\r\n\r\n  const handleSendMessage = async (e) => {\r\n    e.preventDefault();\r\n    if (!inputMessage.trim() || isLoading) return;\r\n\r\n    const userMessage = {\r\n      id: Date.now(),\r\n      role: 'user',\r\n      content: inputMessage.trim(),\r\n      timestamp: new Date().toISOString()\r\n    };\r\n\r\n    // Add user message immediately\r\n    const updatedMessages = [...messages, userMessage];\r\n    setMessages(updatedMessages);\r\n    setInputMessage('');\r\n    setIsLoading(true);\r\n\r\n    // Save user message to backend\r\n    await saveMessageToBackend(userMessage);\r\n\r\n    try {\r\n      // Prepare conversation history for ChatGPT\r\n      const conversationHistory = updatedMessages.map(msg => ({\r\n        role: msg.role,\r\n        content: msg.content\r\n      }));\r\n\r\n      const systemPrompt = `You are an expert travel planning AI assistant. Help users create comprehensive, personalized travel itineraries. Ask questions when you need more information. Provide detailed day-by-day plans with travel, hotels, restaurants, shopping, medical requirements, and weather forecasts.`;\r\n\r\n      // Send message to ChatGPT API with timeout\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\r\n\r\n      try {\r\n        const response = await fetch(`${API_ENDPOINT}/trips/${tripId}/chat`, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            userId: 'Kartik7',\r\n            tripId: tripId,\r\n            message: userMessage.content,\r\n            systemPrompt: systemPrompt,\r\n            conversationHistory: conversationHistory,\r\n            timestamp: userMessage.timestamp\r\n          }),\r\n          signal: controller.signal\r\n        });\r\n\r\n        clearTimeout(timeoutId);\r\n\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          // Add AI response\r\n          const aiMessage = {\r\n            id: Date.now() + 1,\r\n            role: 'assistant',\r\n            content: data.response || data.message || 'I received your message. How can I help you with your trip?',\r\n            timestamp: new Date().toISOString()\r\n          };\r\n          \r\n          // Save AI response to backend\r\n          await saveMessageToBackend(aiMessage);\r\n          \r\n          setMessages(prev => [...prev, aiMessage]);\r\n        } else {\r\n          throw new Error(`API returned status ${response.status}`);\r\n        }\r\n      } catch (fetchError) {\r\n        clearTimeout(timeoutId);\r\n        if (fetchError.name === 'AbortError') {\r\n          const timeoutMessage = {\r\n            id: Date.now() + 1,\r\n            role: 'assistant',\r\n            content: 'The request is taking longer than expected. Please try again, or check your connection.',\r\n            timestamp: new Date().toISOString()\r\n          };\r\n          await saveMessageToBackend(timeoutMessage);\r\n          setMessages(prev => [...prev, timeoutMessage]);\r\n        } else {\r\n          throw fetchError;\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n      // Error response\r\n      const errorMessage = {\r\n        id: Date.now() + 1,\r\n        role: 'assistant',\r\n        content: `I apologize, but I encountered an error processing your request. Please try again. If the problem persists, the service may be temporarily unavailable.\\n\\nError: ${error.message}`,\r\n        timestamp: new Date().toISOString()\r\n      };\r\n      await saveMessageToBackend(errorMessage);\r\n      setMessages(prev => [...prev, errorMessage]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Invite user to view chat\r\n  const handleInviteUser = async (e) => {\r\n    e.preventDefault();\r\n    if (!inviteEmail.trim()) return;\r\n\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/trips/${tripId}/invite`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({\r\n          userId: 'Kartik7',\r\n          tripId: tripId,\r\n          inviteEmail: inviteEmail.trim()\r\n        })\r\n      });\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setSharedUsers(prev => [...prev, { email: inviteEmail.trim(), status: 'invited' }]);\r\n        setInviteEmail('');\r\n        setShowInviteModal(false);\r\n        alert(`Invitation sent to ${inviteEmail.trim()}`);\r\n      } else {\r\n        alert('Failed to send invitation. Please try again.');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error inviting user:', error);\r\n      alert('Failed to send invitation. Please try again.');\r\n    }\r\n  };\r\n\r\n  // Fetch shared users\r\n  useEffect(() => {\r\n    const fetchSharedUsers = async () => {\r\n      try {\r\n        const response = await fetch(`${API_ENDPOINT}/trips/${tripId}/shared-users?userId=Kartik7`);\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          setSharedUsers(data.sharedUsers || []);\r\n        }\r\n      } catch (error) {\r\n        console.error('Error fetching shared users:', error);\r\n      }\r\n    };\r\n    fetchSharedUsers();\r\n  }, [tripId]);\r\n\r\n  const handleKeyDown = (e) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault();\r\n      handleSendMessage(e);\r\n    }\r\n  };\r\n\r\n  // Format message content for better display (markdown-like formatting)\r\n  const formatMessageContent = (content) => {\r\n    if (!content) return '';\r\n    \r\n    // Convert markdown-style formatting to HTML\r\n    let formatted = content\r\n      // Headers\r\n      .replace(/^### (.*$)/gim, '<h3>$1</h3>')\r\n      .replace(/^## (.*$)/gim, '<h2>$1</h2>')\r\n      .replace(/^# (.*$)/gim, '<h1>$1</h1>')\r\n      // Bold\r\n      .replace(/\\*\\*(.*?)\\*\\*/gim, '<strong>$1</strong>')\r\n      // Bullet points\r\n      .replace(/^• (.*$)/gim, '<li>$1</li>')\r\n      .replace(/^- (.*$)/gim, '<li>$1</li>')\r\n      // Line breaks\r\n      .replace(/\\n/g, '<br>');\r\n    \r\n    // Wrap consecutive <li> tags in <ul>\r\n    formatted = formatted.replace(/(<li>.*?<\\/li>(?:<br>)?)+/g, (match) => {\r\n      return '<ul>' + match.replace(/<br>/g, '') + '</ul>';\r\n    });\r\n    \r\n    return formatted;\r\n  };\r\n\r\n  return (\r\n    <div className=\"trip-chat-page\">\r\n      <button className=\"back-button\" onClick={() => navigate('/trips')}>\r\n        <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n          <path d=\"M19 12H5M5 12L12 19M5 12L12 5\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n        </svg>\r\n        Back to My Trips\r\n      </button>\r\n\r\n      {tripInfo && (\r\n        <div className=\"trip-chat-header\">\r\n          <div style={{ display: 'flex', alignItems: 'center', gap: '20px', flex: 1 }}>\r\n            <div className=\"trip-chat-header-image\">\r\n              <img src={tripInfo.image} alt={tripInfo.destination} />\r\n            </div>\r\n            <div className=\"trip-chat-header-info\">\r\n              <h2>{tripInfo.title || `Trip ${tripId}`}</h2>\r\n              <p>{tripInfo.destination || 'Unknown Destination'}</p>\r\n            </div>\r\n          </div>\r\n          <div className=\"trip-chat-header-actions\">\r\n            <button \r\n              className=\"invite-button\"\r\n              onClick={() => setShowInviteModal(true)}\r\n              title=\"Invite user to view chat\"\r\n            >\r\n              <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <path d=\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                <circle cx=\"8.5\" cy=\"7\" r=\"4\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                <path d=\"M20 8v6M23 11h-6\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n              </svg>\r\n              Invite\r\n            </button>\r\n            {sharedUsers.length > 0 && (\r\n              <div className=\"shared-users\">\r\n                <span className=\"shared-users-label\">Shared with:</span>\r\n                {sharedUsers.map((user, idx) => (\r\n                  <span key={idx} className=\"shared-user-badge\">{user.email}</span>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {showInviteModal && (\r\n        <div className=\"invite-modal-overlay\" onClick={() => setShowInviteModal(false)}>\r\n          <div className=\"invite-modal\" onClick={(e) => e.stopPropagation()}>\r\n            <h3>Invite User to View Chat</h3>\r\n            <form onSubmit={handleInviteUser}>\r\n              <input\r\n                type=\"email\"\r\n                className=\"invite-email-input\"\r\n                placeholder=\"Enter email address\"\r\n                value={inviteEmail}\r\n                onChange={(e) => setInviteEmail(e.target.value)}\r\n                required\r\n              />\r\n              <div className=\"invite-modal-actions\">\r\n                <button type=\"button\" onClick={() => setShowInviteModal(false)}>Cancel</button>\r\n                <button type=\"submit\">Send Invitation</button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"chat-container\">\r\n        <div className=\"chat-messages\" ref={messagesEndRef}>\r\n          {messages.length === 0 ? (\r\n            <div className=\"chat-empty-state\">\r\n              <div className=\"empty-state-icon\">\r\n                <svg width=\"64\" height=\"64\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                  <path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n                </svg>\r\n              </div>\r\n              <h3>Start a conversation</h3>\r\n              <p>Ask questions about your trip, request changes, or get recommendations.</p>\r\n            </div>\r\n          ) : (\r\n            messages.map((message) => (\r\n              <div key={message.id} className={`message ${message.role === 'user' ? 'user-message' : 'assistant-message'}`}>\r\n                <div \r\n                  className=\"message-content\"\r\n                  dangerouslySetInnerHTML={{ __html: message.role === 'assistant' ? formatMessageContent(message.content) : message.content }}\r\n                />\r\n                <div className=\"message-timestamp\">\r\n                  {new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n          {isLoading && (\r\n            <div className=\"message assistant-message\">\r\n              <div className=\"message-content\">\r\n                <div className=\"loading-container\">\r\n                  <div className=\"loading-spinner\"></div>\r\n                  <p className=\"loading-text\">Creating your personalized travel plan...</p>\r\n                  <p className=\"loading-subtext\">This may take a few moments</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          <div ref={messagesEndRef} />\r\n        </div>\r\n\r\n        <form className=\"chat-input-form\" onSubmit={handleSendMessage}>\r\n          <div className=\"chat-input-wrapper\">\r\n            <textarea\r\n              ref={inputRef}\r\n              className=\"chat-input\"\r\n              value={inputMessage}\r\n              onChange={(e) => setInputMessage(e.target.value)}\r\n              onKeyDown={handleKeyDown}\r\n              placeholder=\"Message your trip assistant...\"\r\n              rows=\"1\"\r\n              disabled={isLoading}\r\n            />\r\n            <button \r\n              type=\"submit\" \r\n              className=\"chat-send-button\"\r\n              disabled={!inputMessage.trim() || isLoading}\r\n            >\r\n              <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\r\n                <path d=\"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n              </svg>\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default TripChat;\r\n\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}